<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源需求分析站 v20.5</title>
    <!-- 
      /* --- SYSTEM VERSION: v20.5 (Canvas Preview Optimized) --- */
      1. 優化：將 window.onload 改為 DOMContentLoaded，並加入 300ms 佈局緩衝，解決預覽器寬度計算不準的問題。
      2. 增強：加入系統載入遮罩 (Loader)，防止圖表渲染完成前出現空白或佈局跳動。
      3. 修正：圖表初始化加入 try-catch 與 ApexCharts 全域檢查。
      4. 佈局：優化滾動條樣式與側邊欄響應式設計，確保在各類螢幕下皆能順暢閱讀。
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            margin: 0;
        }

        /* 側邊欄樣式 */
        .sidebar { background: #ffffff; }
        .nav-link { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            padding: 0.9rem 1.25rem; 
            border-radius: 0.75rem; 
            color: #64748b; 
            font-weight: 700; 
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .nav-link:hover { 
            background-color: #f1f5f9; 
            color: #1e293b; 
        }
        .nav-link.active { 
            background-color: #eff6ff; 
            color: #2563eb; 
            border-left: 4px solid #2563eb; 
            border-top-left-radius: 0; 
            border-bottom-left-radius: 0; 
        }

        /* 內容區樣式 */
        .main-content { 
            flex: 1;
            height: 100vh;
            overflow-y: auto; 
            scroll-behavior: smooth; 
            padding-bottom: 6rem; 
        }

        /* 卡片設計 */
        .chart-card { 
            background: white; 
            border-radius: 1.5rem; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .chart-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* 自定義捲軸 */
        .main-content::-webkit-scrollbar { width: 6px; }
        .main-content::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* 載入中遮罩 */
        #loader {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- 載入動畫 -->
    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm font-bold text-slate-500 animate-pulse">需求分析數據同步中...</p>
        </div>
    </div>

    <!-- 側邊導航列 -->
    <aside class="w-full md:w-72 border-r border-slate-200 bg-white flex flex-col p-6 h-auto md:h-screen sticky top-0 z-50">
        <div class="flex items-center gap-3 mb-12">
            <div class="bg-blue-600 p-2.5 rounded-2xl text-white shadow-lg">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-black text-lg leading-tight tracking-tighter text-slate-800">能源全方位分析</h1>
                <span class="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded uppercase tracking-widest">v20.5 Demand</span>
            </div>
        </div>
        <nav class="flex-1 space-y-1.5">
            <a href="#" class="nav-link"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> 總體能源概況</a>
            <a href="#" class="nav-link"><i data-lucide="target" class="w-5 h-5"></i> 關鍵發展指標</a>
            <a href="#" class="nav-link active"><i data-lucide="activity" class="w-5 h-5"></i> 能源需求分析</a>
            <a href="#" class="nav-link"><i data-lucide="leaf" class="w-5 h-5"></i> 再生能源分析</a>
            <a href="#" class="nav-link"><i data-lucide="sun" class="w-5 h-5"></i> 太陽光電專區</a>
        </nav>
        <div class="pt-6 border-t border-slate-100 mt-6 md:mt-auto text-[10px] font-black text-slate-400 uppercase text-center tracking-widest leading-relaxed">
            Author: Dr. JASW<br/>© 2025 National Energy Analytics
        </div>
    </aside>

    <!-- 主內容區 -->
    <main class="main-content p-6 md:p-12 lg:p-16">
        <div class="max-w-[1200px] mx-auto space-y-12">
            <header>
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-xs font-bold">需求監控</span>
                </div>
                <h2 class="text-3xl md:text-4xl font-black text-slate-900 tracking-tight">全國能源需求分析</h2>
                <p class="text-slate-500 font-medium mt-2">觀測電力增量來源與工業結構之用電強度變化，為電網韌性提供科學依據。</p>
            </header>

            <!-- 趨勢圖 -->
            <div class="chart-card p-6 md:p-10">
                <div id="demand-trend-chart"></div>
            </div>

            <!-- 部門貢獻圖 -->
            <div class="chart-card p-6 md:p-10">
                <div id="dept-waterfall-chart"></div>
            </div>

            <!-- 工業細分與貢獻 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-card p-6 md:p-10 min-h-[500px]">
                    <div id="ind-pie-chart" class="h-full"></div>
                </div>
                <div class="chart-card p-6 md:p-10">
                    <div id="ind-waterfall-chart"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const THEME = { coal: '#334155', gas: '#0ea5e9', ind: '#1e1b4b', ser: '#3b82f6', res: '#f59e0b', other: '#94a3b8', act: '#1e293b', re: '#22c55e' };

        document.addEventListener("DOMContentLoaded", function() {
            // 初始化 Lucide 圖示
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // 檢查 ApexCharts
            if (typeof ApexCharts === 'undefined') {
                console.error("ApexCharts failed to load.");
                document.getElementById('loader').innerHTML = '<p class="text-red-500 font-bold">圖表引擎載入失敗。</p>';
                return;
            }

            // 延遲渲染以確保佈局穩定
            setTimeout(() => {
                try {
                    // (1) 全國用電趨勢
                    new ApexCharts(document.querySelector("#demand-trend-chart"), {
                        series: [
                            { name: '總用電量 (億度)', type: 'column', data: [2495, 2550, 2613, 2755, 2741, 2801, 2909, 2855] }, 
                            { name: '成長率 (%)', type: 'line', data: [-1.3, 2.2, 2.5, 5.4, -0.5, 2.2, 3.9, 1.2] }
                        ],
                        chart: { height: 450, fontFamily: 'Noto Sans TC', toolbar: { show: false } },
                        title: { text: "全國用電趨勢與年成長率 (2015-2024)", align: 'left', style: { fontSize: '20px', fontWeight: 900, color: '#1e293b' } },
                        xaxis: { categories: ["2015","16","17","18","19","20","21","24"], labels: { style: { fontWeight: 700 } } },
                        yaxis: [
                            { title: { text: '億度', style: { fontWeight: 800 } }, labels: { style: { fontWeight: 700 } } }, 
                            { opposite: true, title: { text: '%', style: { fontWeight: 800 } }, labels: { style: { fontWeight: 700 } } }
                        ],
                        colors: [THEME.ser, '#ef4444'],
                        stroke: { width: [0, 4], curve: 'smooth' },
                        plotOptions: { bar: { borderRadius: 8, columnWidth: '50%' } },
                        dataLabels: { enabled: true, enabledOnSeries: [1], offsetY: -20, style: { fontWeight: 800 } },
                        legend: { position: 'top', horizontalAlign: 'right', fontWeight: 700 }
                    }).render();

                    // (2) 各部門用電成長貢獻
                    new ApexCharts(document.querySelector("#dept-waterfall-chart"), {
                        series: [{ 
                            data: [
                                { x: "2015 總量", y: [0, 2495], color: THEME.coal }, 
                                { x: "工業成長", y: [2495, 2695], color: THEME.ind }, 
                                { x: "服務業成長", y: [2695, 2765], color: THEME.ser }, 
                                { x: "住宅成長", y: [2765, 2875], color: THEME.res }, 
                                { x: "2024 總量", y: [0, 2855], color: THEME.act }
                            ] 
                        }],
                        chart: { type: 'rangeBar', height: 450, fontFamily: 'Noto Sans TC', toolbar: { show: false } },
                        title: { text: "各部門用電成長貢獻度 (2015-2024)", align: 'left', style: { fontSize: '20px', fontWeight: 900, color: '#1e293b' } },
                        plotOptions: { bar: { borderRadius: 6, columnWidth: '60%', dataLabels: { position: 'top' } } },
                        dataLabels: { 
                            enabled: true, 
                            offsetY: -25, 
                            style: { fontWeight: 800, colors: ['#475569'] }, 
                            formatter: (v, o) => o.w.config.series[0].data[o.dataPointIndex].y[1] 
                        },
                        yaxis: { title: { text: '億度', style: { fontWeight: 800 } }, labels: { style: { fontWeight: 700 } } }
                    }).render();

                    // (3) 工業細產業比例
                    new ApexCharts(document.querySelector("#ind-pie-chart"), {
                        series: [650.4, 280.2, 180.1, 469.3],
                        chart: { type: 'donut', height: '100%', fontFamily: 'Noto Sans TC' },
                        labels: ['電子零組件業', '化學材料業', '金屬製品業', '其他工業'],
                        colors: [THEME.ind, THEME.ser, THEME.res, THEME.other],
                        title: { text: "工業細產業用電比例 (2024)", align: 'center', style: { fontSize: '22px', fontWeight: 900, color: '#1e293b' } },
                        plotOptions: { 
                            pie: { 
                                donut: { 
                                    size: '70%', 
                                    labels: { 
                                        show: true, 
                                        total: { show: true, label: '工業總電量', fontWeight: 700, formatter: () => '1,580 億度' } 
                                    } 
                                } 
                            } 
                        },
                        legend: { position: 'bottom', fontSize: '14px', fontWeight: 700, markers: { radius: 12 } }
                    }).render();

                    // (4) 工業細產業成長貢獻
                    new ApexCharts(document.querySelector("#ind-waterfall-chart"), {
                        series: [{ 
                            data: [
                                { x: "2015 基期", y: [0, 1380], color: THEME.coal }, 
                                { x: "電子產業", y: [1380, 1680], color: THEME.ind }, 
                                { x: "化學材料", y: [1680, 1660], color: THEME.re }, 
                                { x: "其他工業", y: [1660, 1580], color: THEME.re }, 
                                { x: "2024 現狀", y: [0, 1580], color: THEME.act }
                            ] 
                        }],
                        chart: { type: 'rangeBar', height: 450, fontFamily: 'Noto Sans TC', toolbar: { show: false } },
                        title: { text: "工業細產業成長貢獻度 (2015-2024)", align: 'left', style: { fontSize: '20px', fontWeight: 900, color: '#1e293b' } },
                        plotOptions: { bar: { borderRadius: 6, columnWidth: '60%', dataLabels: { position: 'top' } } },
                        dataLabels: { 
                            enabled: true, 
                            offsetY: -25, 
                            style: { fontWeight: 800, colors: ['#475569'] }, 
                            formatter: (v, o) => o.w.config.series[0].data[o.dataPointIndex].y[1] 
                        },
                        yaxis: { title: { text: '億度', style: { fontWeight: 800 } }, labels: { style: { fontWeight: 700 } } }
                    }).render();

                    // 隱藏載入畫面
                    const loader = document.getElementById('loader');
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);

                } catch (err) {
                    console.error("Chart rendering error:", err);
                }
            }, 300);
        });
    </script>
</body>
</html>